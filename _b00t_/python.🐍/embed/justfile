# Justfile for embed_anything semantic search integration

# Install embed_anything with GPU support if available
install:
    #!/bin/bash
    set -euo pipefail
    echo "ğŸ“¦ Installing embed_anything..."
    if command -v uv &> /dev/null; then
        echo "Using uv..."
        uv pip install embed-anything-gpu || uv pip install embed-anything
    else
        echo "Using pip3..."
        pip3 install embed-anything-gpu || pip3 install embed-anything
    fi
    echo "âœ… embed_anything installed"

# Check embed_anything version
version:
    @python3 -c "import embed_anything; print(f'embed_anything version: {embed_anything.__version__}')" || echo "âŒ Not installed"

# Embed all datums and save to JSON
embed-all output="datum_embeddings.json":
    #!/bin/bash
    set -euo pipefail
    echo "ğŸ§  Embedding all b00t datums..."
    python3 ~/.b00t/_b00t_/python.ğŸ/embed/semantic_datum_search.py \
        --embed-all \
        --output {{output}}
    echo "âœ… Saved embeddings to {{output}}"

# Semantic search across datums
search query top_k="5":
    #!/bin/bash
    set -euo pipefail
    if [ -f "datum_embeddings.json" ]; then
        echo "ğŸ“‚ Using cached embeddings..."
        python3 ~/.b00t/_b00t_/python.ğŸ/embed/semantic_datum_search.py \
            --query "{{query}}" \
            --input datum_embeddings.json \
            --top-k {{top_k}}
    else
        echo "ğŸ”„ Generating embeddings on-the-fly..."
        python3 ~/.b00t/_b00t_/python.ğŸ/embed/semantic_datum_search.py \
            --query "{{query}}" \
            --top-k {{top_k}}
    fi

# Search with custom model
search-model query model top_k="5":
    python3 ~/.b00t/_b00t_/python.ğŸ/embed/semantic_datum_search.py \
        --query "{{query}}" \
        --model "{{model}}" \
        --top-k {{top_k}}

# Test with example query
test:
    just search "how to install kubernetes" 3

# Clean cached embeddings
clean:
    rm -f datum_embeddings.json
    @echo "âœ… Cleaned cached embeddings"
