#!/bin/bash
# b00t init hook for Claude Code integration
# Auto-generated - DO NOT EDIT manually
# This hook is created by: b00t init --claude-code

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo "$PWD")"

echo "ðŸ¥¾ Initializing b00t for Claude Code..."
echo

# 1. Ensure b00t virtfs is mounted
if ! mountpoint -q ~/.claude/b00t 2>/dev/null; then
    echo "ðŸ“ Mounting b00t virtual filesystem..."

    if command -v b00t-cli &> /dev/null; then
        b00t-cli mount --daemon
        echo "   âœ… Mounted at ~/.claude/b00t"
    else
        echo "   âš ï¸  b00t-cli not found, virtfs not mounted"
        echo "   Install: cd ~/.b00t/b00t-cli && cargo install --path ."
    fi
else
    echo "âœ… b00t virtfs already mounted"
fi
echo

# 2. Install MCP servers via b00t-mcp
if command -v b00t-cli &> /dev/null; then
    echo "ðŸ”Œ Configuring MCP servers..."

    # Install b00t-mcp (itself)
    if ! claude mcp list 2>/dev/null | grep -q "b00t-mcp"; then
        echo "   Installing b00t-mcp..."
        b00t-cli app claudecode mcp install b00t-mcp
    fi

    # Install rust-cargo-docs-rag-mcp for Rust doc search
    if ! claude mcp list 2>/dev/null | grep -q "rust-cargo-docs"; then
        echo "   Installing rust-cargo-docs-rag-mcp..."

        # Check if Docker image exists
        if docker image inspect ghcr.io/promptexecution/rust-cargo-docs-rag-mcp:latest &> /dev/null; then
            # Create temporary MCP config
            cat > /tmp/rust-docs-mcp.json <<'EOF'
{
  "mcpServers": {
    "rust-cargo-docs": {
      "command": "docker",
      "args": [
        "run",
        "--rm",
        "-i",
        "ghcr.io/promptexecution/rust-cargo-docs-rag-mcp:latest"
      ],
      "env": {}
    }
  }
}
EOF
            b00t-cli mcp add --json "$(cat /tmp/rust-docs-mcp.json)" --hint "Rust documentation RAG search"
            b00t-cli app claudecode mcp install rust-cargo-docs
            rm /tmp/rust-docs-mcp.json
        else
            echo "   âš ï¸  Docker image not found: ghcr.io/promptexecution/rust-cargo-docs-rag-mcp:latest"
            echo "   Pull with: docker pull ghcr.io/promptexecution/rust-cargo-docs-rag-mcp:latest"
        fi
    fi

    echo "   âœ… MCP servers configured"
else
    echo "âš ï¸  b00t-cli not available, skipping MCP setup"
fi
echo

# 3. Create project-specific .claude/commands/ from datums
echo "ðŸ“ Generating Claude Code slash commands..."

COMMANDS_DIR="$PROJECT_ROOT/.claude/commands"
mkdir -p "$COMMANDS_DIR"

if [ -f ~/.b00t/b00t-cli/target/release/b00t-cli ]; then
    # Generate commands from mounted virtfs skills
    if mountpoint -q ~/.claude/b00t 2>/dev/null; then
        for skill in ~/.claude/b00t/skills/*.md; do
            skill_name=$(basename "$skill" .md)

            # Create symlink to virtfs skill (dynamically updated)
            ln -sf "$skill" "$COMMANDS_DIR/${skill_name}.md" 2>/dev/null || true
        done

        echo "   âœ… Generated $(ls $COMMANDS_DIR/*.md 2>/dev/null | wc -l) slash commands"
    else
        echo "   âš ï¸  virtfs not mounted, skipping command generation"
    fi
else
    echo "   âš ï¸  b00t-cli not built, skipping command generation"
fi
echo

# 4. Display available skills and agents
if mountpoint -q ~/.claude/b00t 2>/dev/null; then
    SKILL_COUNT=$(ls ~/.claude/b00t/skills/*.md 2>/dev/null | wc -l)
    AGENT_COUNT=$(ls -d ~/.claude/b00t/agents/*/ 2>/dev/null | wc -l)

    echo "ðŸ“Š b00t Status:"
    echo "   Skills available: $SKILL_COUNT"
    echo "   Agents available: $AGENT_COUNT"
    echo "   Mount point: ~/.claude/b00t"
    echo

    echo "ðŸ’¡ Usage:"
    echo "   - Type '/' in Claude Code to see available slash commands"
    echo "   - Skills auto-update when datums change (live reload)"
    echo "   - View all: ls ~/.claude/b00t/skills/"
fi
echo

# 5. Create project-specific b00t config
if [ ! -f "$PROJECT_ROOT/.b00trc" ]; then
    echo "âš™ï¸  Creating project .b00trc..."
    cat > "$PROJECT_ROOT/.b00trc" <<'EOF'
# Project-specific b00t configuration
# Generated by b00t init --claude-code

# Enable virtfs for this project
VIRTFS_ENABLED=true

# Custom mount point (optional)
# VIRTFS_MOUNT_POINT="$PROJECT_ROOT/.claude/b00t"

# Preferred MCP servers
MCP_SERVERS="b00t-mcp,rust-cargo-docs"

# Default embedding model for semantic search
EMBED_MODEL="sentence-transformers/all-MiniLM-L6-v2"
EOF
    echo "   âœ… Created .b00trc"
fi

echo
echo "âœ… b00t initialization complete!"
echo
echo "Next steps:"
echo "  1. Restart Claude Code to load new MCP servers"
echo "  2. Type '/' to see available slash commands"
echo "  3. Try: /rust or /kubernetes for datum-specific help"
